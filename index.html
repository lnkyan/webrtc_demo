<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WebRTC Demo</title>
</head>
<body>
<script src="./node_modules/peerjs/dist/peerjs.min.js"></script>
<h1>只能在localhost或https环境中运行</h1>
<video id="view" controls autoplay></video>
<button onclick="startLive()">主播</button>
<button onclick="accessLive()">观众</button>
<button onclick="pushScreen()">屏幕共享</button>
<button onclick="pushCamera()">开摄像头</button>
<ul id="msg"></ul>
</body>
</html>
<script>
    // import Peer from 'peerjs';
    const ANCHOR_ID = 'ANCHOR_ID'
    let peer, connection

    function startLive() {
        peer = new Peer(ANCHOR_ID, {
            host: location.hostname,
            port: location.port,
            path: '/live',
        });
        peer.on('open', function (id) {
            console.log('WebRTC启动成功，id为:', id);
        });

        peer.on('connection', (conn) => {
            connection = conn
            console.log(`收到[${connection.peer}]节点连接请求`);
            connection.on('open', () => {
                console.log(`[${connection.peer}]节点连接成功`);
                connection.send('hello!');
            });
            connection.on('data', (data) => {
                const li = document.createElement('li')
                li.innerText = data
                document.getElementById('msg').appendChild(li)
            });
        });
    }

    function pushScreen() {
        // firefox
        // navigator.mediaDevices.getUserMedia({video: {mediaSource: 'screen'}, audio: true}, (stream) => {
        //     const call = peer.call('another-peers-id2', stream);
        //     call.on('stream', (remoteStream) => {
        //         // Show stream in some <video> element.
        //     });
        // }, (err) => {
        //     console.error('Failed to get local stream', err);
        // });
        // w3c
        navigator.mediaDevices.getDisplayMedia({video: true}).then(stream => {
            console.log('开始推送桌面视频流')
            const call = peer.call(connection.peer, stream);
            call.on('stream', (remoteStream) => {
                console.log('收到视频流')
                // Show stream in some <video> element.
            });
        }).catch(error => {
            console.error('Failed to get local stream', error);
        })
    }

    function accessLive() {
        const randomId = String(Date.now()) + Math.floor(Math.random() * 1000)
        const targetId = ANCHOR_ID
        peer = new Peer(randomId, {
            host: location.hostname,
            port: location.port,
            path: '/live',
        });
        peer.on('open', function (id) {
            console.log('WebRTC启动成功，id为:', id);
        });

        console.log(`连接${targetId}节点`);
        connection = peer.connect(targetId);
        connection.on('open', () => {
            console.log(`[${targetId}]节点连接成功`);
            // Receive messages
            connection.on('data', function (data) {
                const li = document.createElement('li')
                li.innerText = data
                document.getElementById('msg').appendChild(li)
            });

            // Send messages
            connection.send('Hi!');
        });
        peer.on('call', (call) => {
            console.log('收到推流请求', call)
            call.answer()

            call.on('stream', (remoteStream) => {
                console.log('开始拉流')
                const video = document.getElementById('view')
                video.srcObject = remoteStream
            });
        });
    }

    function pushCamera() {
        peer.on('call', (call) => {
            console.log('收到推流请求', call)

            navigator.mediaDevices.getUserMedia({video: true, audio: true}).then((stream) => {
                console.log('回传摄像头数据')
                call.answer(stream)
            }).catch((error) => {
                console.error('摄像头开启失败', error);
                call.answer()
            });

            call.on('stream', (remoteStream) => {
                console.log('开始拉流')
                const video = document.getElementById('view')
                video.srcObject = remoteStream
            });
        });
    }
</script>